-- Tabela de Usuários (Conta da Família)
CREATE TABLE IF NOT EXISTS usuario (
    id_usuario SERIAL PRIMARY KEY,
    nome_familia VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    senha VARCHAR(255) NOT NULL,
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    atualizado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de Perfis (Membros da Família)
CREATE TABLE IF NOT EXISTS perfil (
    id_perfil SERIAL PRIMARY KEY,
    usuario_id INT NOT NULL,
    nome VARCHAR(255) NOT NULL,
    categoria_familiar VARCHAR(50) NOT NULL,
    cod_perfil VARCHAR(10) UNIQUE NOT NULL,
    renda DECIMAL(10,2) DEFAULT 0.00 NOT NULL,
    is_admin BOOLEAN DEFAULT FALSE,
    senha VARCHAR(255) NOT NULL,
    FOREIGN KEY (usuario_id) REFERENCES usuario(id_usuario)
);

-- Tabela de Categorias (Ex: Moradia, Alimentação, etc.)
CREATE TABLE IF NOT EXISTS categoria (
    id_categoria SERIAL PRIMARY KEY,
    nome_categoria VARCHAR(100) NOT NULL UNIQUE,
    tipo_categoria VARCHAR(20) NOT NULL -- 'receita' ou 'despesa'
);

-- Tabelas de Lookup para Status, Tipos e Recorrências
CREATE TABLE IF NOT EXISTS status_pagamento_tipo (
    id_status_pagamento_tipo SERIAL PRIMARY KEY,
    nome_status VARCHAR(50) UNIQUE NOT NULL
);

CREATE TABLE IF NOT EXISTS tipo_conta_tipo (
    id_tipo_conta_tipo SERIAL PRIMARY KEY,
    nome_tipo VARCHAR(50) UNIQUE NOT NULL
);

CREATE TABLE IF NOT EXISTS recorrencia_tipo (
    id_recorrencia_tipo SERIAL PRIMARY KEY,
    nome_recorrencia VARCHAR(50) UNIQUE NOT NULL
);

CREATE TABLE IF NOT EXISTS tabela_afetada_tipo (
    id_tabela_afetada_tipo SERIAL PRIMARY KEY,
    nome_tabela VARCHAR(50) UNIQUE NOT NULL
);

CREATE TABLE IF NOT EXISTS tipo_acao_tipo (
    id_tipo_acao_tipo SERIAL PRIMARY KEY,
    nome_acao VARCHAR(50) UNIQUE NOT NULL
);

-- Inserção inicial de dados nas tabelas de lookup (se não existirem)
INSERT INTO status_pagamento_tipo (nome_status) VALUES
('pendente'), ('pago'), ('atrasado')
ON CONFLICT (nome_status) DO NOTHING;

INSERT INTO tipo_conta_tipo (nome_tipo) VALUES
('fixa'), ('variável')
ON CONFLICT (nome_tipo) DO NOTHING;

INSERT INTO recorrencia_tipo (nome_recorrencia) VALUES
('nenhuma'), ('mensal'), ('anual'), ('outro')
ON CONFLICT (nome_recorrencia) DO NOTHING;

INSERT INTO tabela_afetada_tipo (nome_tabela) VALUES
('contas'), ('receita')
ON CONFLICT (nome_tabela) DO NOTHING;

INSERT INTO tipo_acao_tipo (nome_acao) VALUES
('insercao'), ('atualizacao'), ('remocao')
ON CONFLICT (nome_acao) DO NOTHING;

-- Inserir categorias pré-definidas
INSERT INTO categoria (nome_categoria, tipo_categoria) VALUES
-- Categorias de Receitas
('Salário', 'receita'),
('Freelancer', 'receita'),
('Investimentos', 'receita'),
('Aluguel', 'receita'),
('Outros (Receita)', 'receita'),
-- Categorias de Despesas
('Moradia', 'despesa'),
('Alimentação', 'despesa'),
('Transporte', 'despesa'),
('Saúde', 'despesa'),
('Educação', 'despesa'),
('Lazer', 'despesa'),
('Vestuário', 'despesa'),
('Contas', 'despesa'),
('Impostos', 'despesa'),
('Outros (Despesa)', 'despesa')
ON CONFLICT (nome_categoria) DO NOTHING;

-- Tabela de Contas (Despesas) - Atualizada com FOREIGN KEYs
CREATE TABLE IF NOT EXISTS contas (
    id_conta SERIAL PRIMARY KEY,
    nome_conta VARCHAR(255) NOT NULL,
    valor_conta DECIMAL(10,2) NOT NULL,
    data_entrega DATE NOT NULL,
    data_vencimento DATE NOT NULL,
    status_pagamento_id INT,
    descricao TEXT,
    tipo_conta_id INT,
    avisado BOOLEAN DEFAULT FALSE,
    recorrencia_id INT,
    perfil_id INT,
    categoria_id INT,
    fixa BOOLEAN DEFAULT FALSE,
    usuario_id INT,
    FOREIGN KEY (perfil_id) REFERENCES perfil(id_perfil),
    FOREIGN KEY (categoria_id) REFERENCES categoria(id_categoria),
    FOREIGN KEY (status_pagamento_id) REFERENCES status_pagamento_tipo(id_status_pagamento_tipo),
    FOREIGN KEY (tipo_conta_id) REFERENCES tipo_conta_tipo(id_tipo_conta_tipo),
    FOREIGN KEY (recorrencia_id) REFERENCES recorrencia_tipo(id_recorrencia_tipo)
);

-- Tabela de Receitas (Entradas de dinheiro)
CREATE TABLE IF NOT EXISTS receita (
    id_receita SERIAL PRIMARY KEY,
    perfil_id INT NOT NULL,
    nome_receita VARCHAR(255) NOT NULL,
    valor_receita DECIMAL(10,2) NOT NULL,
    data_recebimento DATE NOT NULL,
    descricao TEXT,
    categoria_id INT,
    fixa BOOLEAN DEFAULT FALSE,
    usuario_id INT,
    FOREIGN KEY (perfil_id) REFERENCES perfil(id_perfil),
    FOREIGN KEY (categoria_id) REFERENCES categoria(id_categoria)
);

-- Tabela de Histórico de Alterações (Auditoria) - Atualizada com FOREIGN KEYs
CREATE TABLE IF NOT EXISTS historico_alteracoes (
    id_log SERIAL PRIMARY KEY,
    perfil_id INT NOT NULL,
    tabela_afetada_id INT NOT NULL,
    registro_id INT NOT NULL,
    tipo_acao_id INT NOT NULL,
    data_acao TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    detalhes TEXT,
    FOREIGN KEY (perfil_id) REFERENCES perfil(id_perfil),
    FOREIGN KEY (tabela_afetada_id) REFERENCES tabela_afetada_tipo(id_tabela_afetada_tipo),
    FOREIGN KEY (tipo_acao_id) REFERENCES tipo_acao_tipo(id_tipo_acao_tipo)
);

-- Tabela de Permissões por Perfil
CREATE TABLE IF NOT EXISTS permissoes (
    id_permissao SERIAL PRIMARY KEY,
    perfil_id INT NOT NULL UNIQUE,
    ver_receitas BOOLEAN DEFAULT TRUE,
    ver_despesas BOOLEAN DEFAULT TRUE,
    ver_cartoes BOOLEAN DEFAULT TRUE,
    gerenciar_perfis BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (perfil_id) REFERENCES perfil(id_perfil)
);

-- Tabela de Orçamento Mensal
CREATE TABLE IF NOT EXISTS orcamento (
    id_orcamento SERIAL PRIMARY KEY,
    perfil_id INT NOT NULL,
    mes_ano VARCHAR(7) NOT NULL, -- formato: 'AAAA-MM'
    valor_limite DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (perfil_id) REFERENCES perfil(id_perfil),
    UNIQUE (perfil_id, mes_ano)
);

-- Adicionar coluna usuario_id nas tabelas de dados
ALTER TABLE receita ADD COLUMN IF NOT EXISTS usuario_id INT;
ALTER TABLE contas ADD COLUMN IF NOT EXISTS usuario_id INT;

-- Preencher usuario_id com base no perfil_id já existente
UPDATE receita r SET usuario_id = p.usuario_id FROM perfil p WHERE r.perfil_id = p.id_perfil;
UPDATE contas c SET usuario_id = p.usuario_id FROM perfil p WHERE c.perfil_id = p.id_perfil;

-- Tabela de Configurações de Usuário
CREATE TABLE IF NOT EXISTS configuracoes_usuario (
    id_configuracao SERIAL PRIMARY KEY,
    usuario_id INT NOT NULL UNIQUE,
    dark_mode BOOLEAN DEFAULT FALSE,
    zoom INT DEFAULT 100,
    notificacoes BOOLEAN DEFAULT TRUE,
    privacidade BOOLEAN DEFAULT FALSE,
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    atualizado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (usuario_id) REFERENCES usuario(id_usuario) ON DELETE CASCADE
);